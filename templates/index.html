{% extends "base.html" %}

{% block title %}Dashboard - Teamarr{% endblock %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2>Dashboard</h2>
        <div>
            <button onclick="generateEPG()" class="btn btn-success">üöÄ Generate EPG</button>
            <a href="{{ url_for('download_epg') }}" class="btn btn-primary">üì• Download EPG</a>
            <button onclick="showEPGUrl()" class="btn btn-secondary">üîó Get EPG URL</button>
        </div>
    </div>

    <!-- Stats Grid -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-value">{{ teams|length }}</div>
            <div class="stat-label">Active Teams</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">
                {% if history and history[0].generated_at_local %}
                    {{ history[0].generated_at_local }}
                {% elif history and history[0].generated_at %}
                    {{ history[0].generated_at }}
                {% else %}
                    Never
                {% endif %}
            </div>
            <div class="stat-label">Last EPG Generated</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="events-count">
                {% if history %}
                    {{ history[0].num_events if history[0].num_events else '‚Äî' }}
                {% else %}
                    0
                {% endif %}
            </div>
            <div class="stat-label">Events in Last EPG</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="programs-count">
                {% if history %}
                    {{ history[0].num_programmes }}
                {% else %}
                    0
                {% endif %}
            </div>
            <div class="stat-label">Total Programs in Last EPG</div>
        </div>
    </div>
</div>

<!-- Active Teams -->
<div class="card">
    <div class="card-header">
        <h2>Active Teams</h2>
        <a href="{{ url_for('add_team') }}" class="btn btn-primary">‚ûï Add Team</a>
    </div>

    {% if teams %}
        <table class="table">
            <thead>
                <tr>
                    <th>Team</th>
                    <th>League</th>
                    <th>Channel ID</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for team in teams %}
                <tr>
                    <td>
                        <strong>{{ team.team_name }}</strong>
                        <br>
                        <small class="help-text">{{ team.team_abbrev }}</small>
                    </td>
                    <td>
                        <span class="badge badge-info">{{ team.league_name }}</span>
                    </td>
                    <td><code>{{ team.channel_id }}</code></td>
                    <td class="table-actions">
                        <a href="{{ url_for('edit_team', team_id=team.id) }}" class="btn btn-sm btn-secondary">‚úèÔ∏è Edit</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <div class="empty-state">
            <div class="empty-state-icon">üèÄ</div>
            <h3>No Teams Yet</h3>
            <p>Add your first team to get started generating EPG files.</p>
            <a href="{{ url_for('add_team') }}" class="btn btn-primary">‚ûï Add Your First Team</a>
        </div>
    {% endif %}
</div>

<!-- Recent EPG Generations -->
{% if history %}
<div class="card">
    <div class="card-header">
        <h2>Recent EPG Generations</h2>
    </div>

    <table class="table">
        <thead>
            <tr>
                <th>Date</th>
                <th>Channels</th>
                <th>Programs</th>
                <th>Time</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            {% for item in history %}
            <tr>
                <td>{{ item.generated_at_local }}</td>
                <td>{{ item.num_channels }}</td>
                <td>{{ item.num_programmes }}</td>
                <td>{{ "%.2f"|format(item.generation_time_seconds) }}s</td>
                <td>
                    {% if item.status == 'success' %}
                        <span class="badge badge-success">‚úì Success</span>
                    {% else %}
                        <span class="badge badge-danger">‚úó {{ item.status }}</span>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}


{% endblock %}

{% block scripts %}
<script>
function generateEPG() {
    showNotification('Generating EPG... Please wait.', 'info', 0, 'Generating EPG');

    fetch('/generate', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            showNotification(data.error, 'error', 10000);
        } else {
            const message = `<strong>Channels:</strong> ${data.num_channels} | <strong>Events:</strong> ${data.num_events} | <strong>Total Programs:</strong> ${data.num_programmes} | <strong>Time:</strong> ${data.generation_time.toFixed(2)}s`;
            showNotification(message, 'success', 10000, 'EPG Generated Successfully');

            // Reload page after 2 seconds to show updated stats
            setTimeout(() => location.reload(), 2000);
        }
    })
    .catch(error => {
        showNotification(error.message, 'error', 10000);
    });
}

function showEPGUrl() {
    const url = window.location.origin + '/teamarr.xml';
    const message = `
        <strong>EPG URL for IPTV:</strong><br>
        <input type="text" value="${url}" readonly onclick="this.select()"
               style="width: 100%; padding: 0.5rem; margin-top: 0.5rem; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text-primary); border-radius: 4px; font-family: monospace;">
        <small style="display: block; margin-top: 0.5rem; color: var(--text-muted);">
            Click the URL to select it, then copy and paste into your IPTV app.
        </small>
    `;
    showNotification(message, 'info', 0, 'EPG URL');
}
</script>
{% endblock %}
